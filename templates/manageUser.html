<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Majestic Admin Pro</title>
  <link rel="stylesheet" href="{{ url_for('serve_assets', filename='css/style.css') }}">
  <link rel="shortcut icon" href="{{ url_for('serve_assets', filename='images/favicon.ico') }}">
  <!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap JS (ensure you are using a version that includes the modal function) -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>


  <style>
    .manageUsersLink .dropdown .dropdown-toggle:after {
      display: none !important;
    }
    .manageUsersLink .dropdown .dropdown-menu {
      margin-top: 0.6rem;
    }
    .dropdown .dropdown-toggle:after {
      content: none !important;
    }
    .hide {
      display: none !important;
    }
    .blue {
      color: blue;
      margin-left: 1rem;
    }
    .appHeader{
       margin-left: 1rem !important;
       color: green;
       font-weight: 800;
    }
    .liadj {
      font-weight: 900 !important;
      font-size: 1.2rem !important;
    }
    
    .bWhite {
      background-color: white !important;
    }
    .manageUsersLink .dropdown .dropdown-menu {
    margin-top: 0.4rem;
}
.content-wrapper {
  margin-top: 4rem !important;
}
body {
  background: #f3f3f3 !important;
}
.card{
  border-radius: 2rem !important;
}

  </style>
</head>
<body>
  <div class="container-scroller">
    <nav class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row bWhite">
      <h3 class="appHeader">khazanapay</h3>
  <div class="navbar-brand-wrapper d-flex justify-content-center hide">
    <div class="navbar-brand-inner-wrapper d-flex justify-content-between align-items-center w-100">
      <a class="navbar-brand brand-logo" href="index.html"><img src="../../../assets/images/logo.svg"
          alt="logo" /></a>
      <a class="navbar-brand brand-logo-white" href="index.html"><img src="../../../assets/images/logo-white.svg"
          alt="logo" /></a>
      <a class="navbar-brand brand-logo-mini" href="index.html"><img src="../../../assets/images/logo-mini.svg"
          alt="logo" /></a>
      <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
        <span class="mdi mdi-sort-variant"></span>
      </button>
    </div>
  </div>
  <div class="navbar-menu-wrapper d-flex align-items-center justify-content-end">
    <ul class="nav">
      <li class="nav-item">
        <a class="nav-link liadj" href="/admin/dashBoard">
          <i class="mdi mdi-home menu-icon"></i>
          <span class="menu-title">Dashboard</span>
        </a>
      </li>    

      <li class="nav-item manageUsersLink">
        <div class="dropdown show">
          <a class="nav-link dropdown-toggle liadj" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
           Manage users
          </a>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
            <a class="dropdown-item" href="#">Manage User Credintials </a>
            <a class="dropdown-item" href="/admin/userWalletAndKycUpdate">User Wallet Update/User Kyc Update</a>
          </div>
        </div>       
      </li>
    </ul>
    <ul class="navbar-nav navbar-nav-right">
        
      <li class="nav-item nav-profile dropdown">
      
        <a class="nav-link dropdown-toggle liadj" href="#" data-bs-toggle="dropdown" id="profileDropdown">
          <span class="nav-profile-name userName">Louis Barnett</span>
        </a>
        <div class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="profileDropdown">
          <a class="dropdown-item">
            <i class="mdi mdi-cog text-primary"></i>
            Settings
          </a>
          <a class="dropdown-item" href="/">
            <i class="mdi mdi-logout text-primary"></i>
            Logout
          </a>
        </div>
      </li>
    </ul>
    <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button"
      data-toggle="offcanvas">
      <span class="mdi mdi-menu"></span>
    </button>
  </div>
</nav>
    <!-- partial -->
    <div class="container-fluid">      
      <div class="">
        <div class="content-wrapper">
          <div class="row">
            <div class="col-md-12 grid-margin">
              <div class="d-flex justify-content-between flex-wrap">
                <div class="d-flex align-items-end flex-wrap">
                  <div class="me-md-3 me-xl-5">
                    <h2>Welcome back <b class="userName blue"></b></h2>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                    <p class="card-title">User Mangement</p>
                    <div class="table-responsive">
                      <div class="tableContainerDiv"></div>
                    </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" id="exampleModalCenter">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLongTitle">Update User Details</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="container-fluid">
                    <div class="row">
                      <div class="col-md-6"> 
                        <div data-mdb-input-init class="form-outline mb-4">
                        <label class="form-label" for="form2Example11" >Mobile Number</label>
                        <input type="tel" id="mobileNumberForUpdate" class="form-control" disabled/>
                      </div>
                    </div>
                      <div class="col-md-6"><div data-mdb-input-init class="form-outline mb-4">
                        <label class="form-label" for="form2Example11" >User Name</label
                        >
                        <input
                          type="text"
                          id="usernameForUpdate"
                          class="form-control" disabled>
                          </div></div>
                    </div>
                    <div class="row">
                      <div class="col-md-6"> <div data-mdb-input-init class="form-outline mb-4">
                        <label class="form-label" for="form2Example11" >Wallet Ballence</label>
                        <input
                          type="text"
                          id="walletBallenceForUpdate"
                          class="form-control" disabled/>
                      </div></div>
                      <div class="col-md-6"><div data-mdb-input-init class="form-outline mb-4">
                        <label class="form-label" for="form2Example11" >User Current Status</label
                        >
                        <input
                          type="text"
                          id="statusForUpdate"
                          class="form-control" disabled>
                          </div></div>
                    </div>
    
                    <div class="row">
                      <div class="col-md-6"> <div data-mdb-input-init class="form-outline mb-4">
                        <label class="form-label" for="form2Example11" >Recharge Wallet</label
                        >
                        <input
                          type="number"
                          id="rechargeAmount"
                          class="form-control"
                        />
                      </div></div>
                      <div class="col-md-3">
                        <label for="statusDropdown" class="form-label">Change Status</label>
                          <select id="statusDropdown" class="form-select">
                            <option value="">Select Status for User</option>
                            <option value="True">Activate</option>
                            <option value="False">Inactivate</option>
                          </select>
                      </div>

                      <div class="col-md-3">
                        <label for="transactionDropdown" class="form-label">Transaction Type</label>
                          <select id="transactionDropdown" class="form-select">
                            <option value="">Select Transaction Type</option>
                            <option value="Credit">Credit</option>
                            <option value="Credit">Debit</option>
                          </select>
                      </div>

                    </div>
                   <div class="error-message-UpdateForm" style="color:red ;text-align:center"></div>
                    <div class="success-message-UpdateForm" style="color:green ;text-align:center"></div>
    
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" onclick="rechargeUser();" id = "recharegWalletBtn">Credit Wallet</button>
                   <button type="button" class="btn btn-primary" onclick="UpdateUserStatus();">Update Status</button>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" id="userHistoryModel">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLongTitle">User Wallet History</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="container-fluid">
                  
                    <div class="card" >
                          <div class="card-header">
                            <h4>Wallet History</h4>
                          </div>
                      <div class="card-body">
                        <div class="row justify-content-left">
                           <div class="table-responsive">
                              <div id="table-container-wallet-user"></div>
                           </div>
                            </div>
                      </div>
                    </div>
              </div>
            </div>
          </div>
    
          
        </div>
      </div>
    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Load jQuery first -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<!-- Load Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>


</body>

</html>
<script>
     var access_token = sessionStorage.getItem("access_token");
     var username = sessionStorage.getItem("username");
  $(document).ready(function() {
    if(!access_token){
        $(location).attr("href", "login.html");
      } else{
        callUsersForAdmin();
      }
    // Initialize the dropdown on click
    $('#profileDropdown').on('click', function(e) {
      e.preventDefault(); // Prevent the default link behavior
      $(this).next('.dropdown-menu').toggleClass('show'); // Toggle the dropdown menu
     
    });

    // Close the dropdown when clicking outside
    $(document).on('click', function(e) {
      if (!$(e.target).closest('.nav-profile').length) {
        $('.dropdown-menu').removeClass('show'); // Hide the dropdown menu
      }
    });
   
    


    $('#manageUsersLink').on('click', function(event) {
        event.preventDefault(); // Prevent default anchor click behavior

        // Collapse other open menus if needed
        $('#auth').collapse('toggle');
      });
  });
  $(".userName").html(username);
  function callUsersForAdmin(){
         let url = "https://khazanapay.net/admin/getUsers";
        const headers = {
          "Authorization": "Bearer "+access_token,
        };
    
        $.ajax({
          url: url,
          type: "GET",
          headers: headers,
          success: function (response) {
            var userList = response;
            usersListPrev= userList;
            createTable(userList);
       
          },
          error: function (xhr, status, error) {
            alert("Something went wrong. Please login again.");
            window.location.href = "/";
            // $(location).attr("href", "index.html");
            return;
          },
        });
      }

  function createTable(data) {
        if (data ) {
          let headers = [
            "First name",
            "Last Name",
            "UserName",
            "Mobile Number",
            "Wallet Ballance",
            "Kyc Status",
            "Actions",
            "Wallet History"
          ];

          let $table = $('<table class="table  curved-table"></table>'); 

          let $headerRow = $('<thead class="thead-dark"></thead>'); 
          let $headerRowContent = $("<tr></tr>");

          headers.forEach(function (headerText) {
            $headerRowContent.append($("<th scope='col'></th>").text(headerText));
          });

          $headerRow.append($headerRowContent);
          $table.append($headerRow);

          let $tableBody = $("<tbody></tbody>");
              data.forEach(function (item) {
            let $row = $("<tr></tr>");

            let first_name = item["first_name"];
            let last_name = item["last_name"];
            let username = item["username"];
            let phone_number = item["phone_number"];
            let payout_wallet = item["payout_wallet"];
            let kyc_status = item["kyc_status"];
                let kycForUi= "";
                if(kyc_status =="True"){
                     kycForUi = "Active";
                } else{
                  kycForUi="InActive"
                }
            let buttonForUpdate = "  <a class='btn btn-primary btn-sm'  data-toggle='modal' data-target='#exampleModalCenter' onclick= updateUser('"+username+"');>  Update User  </button>"
                 let buttonForHistory = "  <a class='btn btn-primary btn-sm' style='background-color:green;' data-toggle='modal' data-target='#userHistoryModel' onclick= showHistoryForUser('"+username+"');>  User wallet History</button>"
            $row.append($("<td></td>").text(first_name));
            $row.append($("<td></td>").text(last_name));
            $row.append($("<td></td>").text(username));
            $row.append($("<td></td>").text(phone_number));
            $row.append($("<td></td>").text(payout_wallet));
            $row.append($("<td></td>").text(kycForUi));
            $row.append($("<td></td>").html(buttonForUpdate));
            $row.append($("<td></td>").html(buttonForHistory));
            $tableBody.append($row);

          });

          $table.append($tableBody);

          $(".tableContainerDiv").append($table);
        } else {
          $(".tableContainerDiv").append("<p>No Users found.</p>");
        }
      }
      function updateUser(userName){
        for(let i=0;i<usersListPrev.length;i++){
          if(userName == usersListPrev[i]["username"]){

            let kycForUi= "";
            if(usersListPrev[i]["kyc_status"] =="True"){
                 kycForUi = "Active";
            } else{
              kycForUi="InActive"
            }
            $("#mobileNumberForUpdate").val(usersListPrev[i]["phone_number"]);
            $("#usernameForUpdate").val(usersListPrev[i]["username"]);
            $("#walletBallenceForUpdate").val(usersListPrev[i]["payout_wallet"]);
            $("#statusForUpdate").val(kycForUi);
            $("#rechargeAmount").val("");
            $("#statusDropdown").val("");
            $("#exampleModalCenter").modal("show");
          }
        }
      }
      function rechargeUser(){
        var userForRecharge = $("#usernameForUpdate").val();
        var rechargableAmount = $("#rechargeAmount").val();
        var statusCurrent = $("#statusForUpdate").val();
        var transactionType = $("#transactionDropdown").val();
        if(rechargableAmount ==0){
           $(".error-message-UpdateForm").text("Please enter valid amount to recharge");
          return;
        } else if(rechargableAmount >0 && statusCurrent =="Active"){
          $(".error-message-UpdateForm").text("You cant Recharge the user ,until he was deactivated .first deactive him and try again");
          return;
        } else if (transactionType == "Select Transaction Type") {
          $(".error-message-UpdateForm").text("Please select transaction type.");
        } 
          if (transactionType == "Credit"){
           $(".error-message-UpdateForm").text("");
           let url = "https://khazanapay.net/admin/rechargeWallet";

          const headers = {
            "Authorization": "Bearer "+access_token,
             "Content-Type": "application/json",
          };
          const payload = {
            username: $("#usernameForUpdate").val(),
            amount : rechargableAmount,
          };

          $.ajax({
            url: url,
            type: "POST",
            headers: headers,
             data: JSON.stringify(payload),
            success: function (response) {
            $(".success-message-UpdateForm").text(response.successMsg);
              $(".error-message-UpdateForm").text("");
              setTimeout(function() {
                location.reload();
              }, 2000);
            },
            error: function (xhr, status, error) {
              alert("Something went wrong. Please login again.");
            window.location.href = "/";
               $(".error-message-UpdateForm").text("SomeThing went wrong please try again");
               $(".success-message-UpdateForm").text("");
              return;
            },
          });
        }
        
      }

      function UpdateUserStatus(){
        var statusForUpdate = $('#statusDropdown').val();
         var statusCurrent =$("#statusForUpdate").val();
        if(!statusForUpdate){
          $(".error-message-UpdateForm").text("Please select the Status First");
          return;
        } else{
          if(statusForUpdate == "True" && statusCurrent =="Active"){
            $(".error-message-UpdateForm").text("User is already Active");
            return;
          } else if(statusForUpdate == "False" && statusCurrent =="InActive"){
            $(".error-message-UpdateForm").text("User is already InActive");
            return;
          } else{
            $(".error-message-UpdateForm").text("");
            let url = "https://khazanapay.net/admin/updateKyc";

            const headers = {
              "Authorization": "Bearer "+access_token,
               "Content-Type": "application/json",
            };
            const payload = {
              username: $("#usernameForUpdate").val(),
              KYC_Status: statusForUpdate,
            };

            $.ajax({
              url: url,
              type: "POST",
              headers: headers,
               data: JSON.stringify(payload),
              success: function (response) {
              $(".success-message-UpdateForm").text(response.successMsg);
                $(".error-message-UpdateForm").text("");

                if (statusForUpdate == "True") {
                  $("#statusForUpdate").val("Active");
                } else {
                  $("#statusForUpdate").val("Inactive");
                }
                
              },
              error: function (xhr, status, error) {
                alert("Something went wrong. Please login again.");
            window.location.href = "/";
                if (xhr.responseJSON && xhr.responseJSON.errorMsg) {
                  var errorMessage = xhr.responseJSON.errorMsg;
                  $(".error-message-UpdateForm").text(errorMessage);
                } 
                 
                return;
              },
            });
          }
        }
      }

      function createWalletTable(data,isAdmin){
        if (data ) {
          let headers = [
            "Id",
            "User Name",
            "Client Id",
            "Amount",
            "Transaction Type",
            "Date",
            "Reason"
          ];

          let $table = $('<table class="table  curved-table"></table>'); 

          let $headerRow = $('<thead class="thead-dark"></thead>'); 
          let $headerRowContent = $("<tr></tr>");

          headers.forEach(function (headerText) {
            $headerRowContent.append($("<th scope='col'></th>").text(headerText));
          });

          $headerRow.append($headerRowContent);
          $table.append($headerRow);

          let $tableBody = $("<tbody></tbody>");
              data.forEach(function (item) {
            let $row = $("<tr></tr>");

            let id = item["id"];
            let username = item["username"];
            let client_id = item["client_id"];
            let amount = item["amount"];
            let transaction_type = item["transaction_type"];
            let date_time = item["date_time"];
            let reason = item["reason"]
               
            let buttonForUpdate = "  <a class='btn btn-primary btn-sm'  data-toggle='modal' data-target='#exampleModalCenter' onclick= updateUser('"+username+"');>  Update User  </button>"
                 let buttonForHistory = "  <a class='btn btn-primary btn-sm' onclick= 'showHistory('"+username+"'')>  User wallet History</button>"
            $row.append($("<td></td>").text(id));
            $row.append($("<td></td>").text(username));
            $row.append($("<td></td>").text(client_id));
            $row.append($("<td></td>").text(amount));
            $row.append($("<td></td>").text(transaction_type));
            $row.append($("<td></td>").text(date_time));
            $row.append($("<td></td>").text(reason));
            $tableBody.append($row);

          });

          $table.append($tableBody);
          if(isAdmin){
             $("#table-container-wallet").append($table);
          } else{
             $("#table-container-wallet-user").append($table);
          }

         
        } else {
           if(isAdmin){
            $("#table-container-wallet").append("<p>No transactions found.</p>");
           }else{
             $("#table-container-wallet-user").append("<p>No transactions found.</p>");
           }
        }
      }
      function showHistoryForUser(userName){
        $("#table-container-wallet-user").html("");
         let url = "https://khazanapay.net/admin/getWalletHistoryForUser";
        const headers = {
          "Authorization": "Bearer "+access_token,
          "Content-Type": "application/json",
        };
        const payload = {
          username: userName,
        };

        $.ajax({
          url: url,
          type: "POST",
          headers: headers,
           data: JSON.stringify(payload),
          success: function (response) {
            var userList = response;
             createWalletTable(userList,false);


          },
          error: function (xhr, status, error) {
            alert("Something went wrong. Please login again.");
            window.location.href = "/";
            if (xhr.responseJSON && xhr.responseJSON.errorMsg) {
              var errorMessage = xhr.responseJSON.errorMsg;
               alert(errorMessage);
            } 
            return;
          },
        });
      }

      $('#transactionDropdown').change(function() {
        var selectedText = $('#transactionDropdown option:selected').text();
        if (selectedText == "Credit") {
            $('#recharegWalletBtn').html("Credit Wallet");
        } else {
            $('#recharegWalletBtn').text('Debit Wallet');
        }
    });

</script>

