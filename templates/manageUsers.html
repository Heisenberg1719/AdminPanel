<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Khazana Pay Admin</title>
  <!-- Materialize CSS -->
  <link rel="stylesheet" href="{{ url_for('serve_assets', filename='css/materialize.min.css') }}">
  <!-- Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    body {
      background-color: aliceblue !important;
      font-size: large;
      
    }
    .headerRow {
      background-color: #031403 ;
      color: white;
      font-size: x-large;
      margin-top: -3rem;
    }
    .homeHeader {
      font-weight: 600 !important;
      margin-left: 1rem;
    }
    .card-panel {
      border-radius: 14px !important;
    }
    .btn {
      background-color: #2196f3;
      width: 50%;
      border-radius: 14px;
    }
    label {
      font-size: larger !important;
    }
    .toast {
      border-radius: 14px !important;
    }
    nav {
      background-color: #20208f !important;
      margin-top: -3rem;
    }
    span {
      font-weight: bold !important;
      color: red;
    }
    .dataTables_wrapper .dataTables_filter input {
      height: auto;
    }
    .card {
      overflow: auto;
    }
    #walletTableContainer .dataTables_wrapper .dataTables_filter {
      margin-right: 2rem;
    }
    .dataTables_wrapper .dataTables_length {
      display: none;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #18a9e4;
      color: white;
    }
    .modal .modal-close {
        margin-right: 1rem;
    }
    .tabelheader {
      background-color: aliceblue;
    }
    .modal {
      max-height: fit-content;
    }

    #modalLoader {
    max-width: fit-content;
    overflow: visible;
    top: 30% !important;
    background-color: #dde6e5;
}
.material-icons {
  margin-left: -5rem;
}

  </style>
</head>
<body>
  <nav>
    <div class="nav-wrapper">
      <h1 class="homeHeader">
        <a href="#" class="brand-logo">khazanapay Admin</a>
      </h1>
      <ul id="nav-mobile" class="right">
        <li><a href="/admin/dashBoard">Dashboard</a></li>
        <li class="active"> <a href="/admin/userWalletAndKycUpdate">Manage Users</a></li>
        <li><a href="/">Log Out</a></li>
      </ul>
    </div>
  </nav>
  <div class="row">
    <div class="col s12 m12 l12 xl12">
      <div class="card">
        <div class="card-content center-align">
          <span class="card-title">Admin Users</span>
          <div class="preloader-wrapper big active" id="manageLoader">
            <div class="spinner-layer spinner-blue">
              <div class="circle-clipper left"><div class="circle"></div></div>
              <div class="gap-patch"><div class="circle"></div></div>
              <div class="circle-clipper right"><div class="circle"></div></div>
            </div>
            <div class="spinner-layer spinner-red">
              <div class="circle-clipper left"><div class="circle"></div></div>
              <div class="gap-patch"><div class="circle"></div></div>
              <div class="circle-clipper right"><div class="circle"></div></div>
            </div>
            <div class="spinner-layer spinner-yellow">
              <div class="circle-clipper left"><div class="circle"></div></div>
              <div class="gap-patch"><div class="circle"></div></div>
              <div class="circle-clipper right"><div class="circle"></div></div>
            </div>
            <div class="spinner-layer spinner-green">
              <div class="circle-clipper left"><div class="circle"></div></div>
              <div class="gap-patch"><div class="circle"></div></div>
              <div class="circle-clipper right"><div class="circle"></div></div>
            </div>
          </div>
          <div id="userDetailsTableContainer"></div>
        </div>
      </div>
    </div>
    <div class="col s12 m12 l12 xl12">
      <div class="card">
        <div class="card-content center-align">
          <span class="card-title">Wallet History</span>
          <span class="blue-text">If you want to see any history of users, please click the history button you want.</span><br><br>
          <span class="userNameSpan green-text"></span>
         
          <div class="preloader-wrapper big active hide" id="walletHistoryLoader">
            <div class="spinner-layer spinner-blue">
              <div class="circle-clipper left"><div class="circle"></div></div>
              <div class="gap-patch"><div class="circle"></div></div>
              <div class="circle-clipper right"><div class="circle"></div></div>
            </div>
            <div class="spinner-layer spinner-red">
              <div class="circle-clipper left"><div class="circle"></div></div>
              <div class="gap-patch"><div class="circle"></div></div>
              <div class="circle-clipper right"><div class="circle"></div></div>
            </div>
            <div class="spinner-layer spinner-yellow">
              <div class="circle-clipper left"><div class="circle"></div></div>
              <div class="gap-patch"><div class="circle"></div></div>
              <div class="circle-clipper right"><div class="circle"></div></div>
            </div>
            <div class="spinner-layer spinner-green">
              <div class="circle-clipper left"><div class="circle"></div></div>
              <div class="gap-patch"><div class="circle"></div></div>
              <div class="circle-clipper right"><div class="circle"></div></div>
            </div>
          </div>
          <div id="walletDetailsTableContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="manageUserDetailsModal" class="modal">
    <div class="modal-header">
      <h4 style="padding: 1rem !important;">Manage User Details</h4>
      <a href="#!" class="modal-close white-text"><i class="small material-icons">close</i></a>
    </div>
    <div class="modal-content">
      <div class="row">
        <div class="input-field col s12 m12 l6 xl6">
          <input id="mobileNumber" type="tel" class="validate" disabled>
          <label for="mobileNumber">Mobile Number</label>
        </div>
        <div class="input-field col s12 m12 l6 xl6">
          <input id="userName" type="text" class="validate" disabled>
          <label for="userName">UserName</label>
        </div>
      </div>

      <div class="row">
        <div class="input-field col s12 m12 l6 xl6">
          <input id="walletBalance" type="text" class="validate" disabled>
          <label for="walletBalance">Wallet Balance</label>
        </div>
        <div class="input-field col s12 m12 l6 xl6">
          <input id="currentStatus" type="text" class="validate" disabled>
          <label for="currentStatus">Current Status</label>
        </div>
      </div>
      
      <div class="row">
        <div class="input-field col s12 m6 l6 xl6">
          <input placeholder="Please enter recharge amount" id="rechargeAmount" type="number" class="validate">
          <label for="rechargeAmount">Recharge Amount</label>
        </div>
        <div class="input-field col s12 m6 l6 xl6">
          <select id="transType">
            <option value="" disabled selected>Select Transaction Type</option>
            <option value="Credit">Credit</option>
            <option value="Debit">Debit</option>
          </select>
        </div>
      </div>

      <div class="row center-align">
          <div>
            <a href="#!" class="waves-effect waves-light btn rechargeBtn" id ="creditOrDebitBtn" onclick="creditOrDebitUserWallet()">Credit</a>
          </div>
      </div>
    </div>
  </div>

  <div id = "modalLoader" class="modal">
    <div class="modal-content center-align">
      <div class="preloader-wrapper big active modalLoaderContent">
        <div class="spinner-layer spinner-blue">
          <div class="circle-clipper left">
            <div class="circle"></div>
          </div><div class="gap-patch">
            <div class="circle"></div>
          </div><div class="circle-clipper right">
            <div class="circle"></div>
          </div>
        </div>
  
        <div class="spinner-layer spinner-red">
          <div class="circle-clipper left">
            <div class="circle"></div>
          </div><div class="gap-patch">
            <div class="circle"></div>
          </div><div class="circle-clipper right">
            <div class="circle"></div>
          </div>
        </div>
  
        <div class="spinner-layer spinner-yellow">
          <div class="circle-clipper left">
            <div class="circle"></div>
          </div><div class="gap-patch">
            <div class="circle"></div>
          </div><div class="circle-clipper right">
            <div class="circle"></div>
          </div>
        </div>
  
        <div class="spinner-layer spinner-green">
          <div class="circle-clipper left">
            <div class="circle"></div>
          </div><div class="gap-patch">
            <div class="circle"></div>
          </div><div class="circle-clipper right">
            <div class="circle"></div>
          </div>
        </div>
      </div>

      <i class="large material-icons hide" id="successStatus">check_circle</i>
      <i class="large material-icons hide" id="errorStatus">error</i>

    </div>
  </div>



  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <!-- Materialize JS -->
  <script src="{{ url_for('serve_assets', filename='js/materialize.min.js') }}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
  
  <script>
    var access_token = sessionStorage.getItem("access_token");
    var username = sessionStorage.getItem("username");
    if (!access_token || !username) {
      M.toast({
        html: 'Your session expired. Please login again.'
      });
      window.location.href = "/";
    }

    $(document).ready(function() {
      $('.modal').modal();
      $('select').formSelect();
      getUserDetails();
    });
    var isProcessing = false;

    function getUserDetails() {
      $("#manageLoader").removeClass("hide");
      $("#userDetailsTableContainer").html("");
      let url = "https://khazanapay.net/admin/getUsers";
      const headers = {
        "Authorization": "Bearer " + access_token,
      };

      $.ajax({
        url: url,
        type: "GET",
        headers: headers,
        success: function(response) {
          var userList = response;
          usersListPrev= userList;
          $("#manageLoader").addClass("hide");
          createUserDetailsTable(userList);
        },
        error: function(xhr, status, error) {
          alert("Something went wrong. Please login again.");
          window.location.href = "/";
          return;
        },
      });
    }


    function showHistoryForUser(userName) {
      $("#walletHistoryLoader").removeClass("hide");
      $("#walletDetailsTableContainer").html("");
      let url = "https://khazanapay.net/admin/getWalletHistoryForUser";
      const headers = {
        "Authorization": "Bearer " + access_token,
        "Content-Type": "application/json",
      };
      const payload = {
        username: userName,
      };

      $.ajax({
        url: url,
        type: "POST",
        headers: headers,
        data: JSON.stringify(payload),
        success: function(response) {
          var userList = response;
          $("#walletHistoryLoader").addClass("hide");
          $(".userNameSpan").text("User Name: "+userName);
          createWalletHistoryTable(userList);
          document.getElementById('walletDetailsTableContainer').scrollIntoView({ behavior: 'smooth' });
        },
        error: function(xhr, status, error) {
          alert("Something went wrong. Please login again.");
          window.location.href = "/";
          if (xhr.responseJSON && xhr.responseJSON.errorMsg) {
            var errorMessage = xhr.responseJSON.errorMsg;
            alert(errorMessage);
          }
          return;
        },
      });
    }

    function createUserDetailsTable(data) {
  if (data) {
    let headers = ["First Name", "Last Name", "UserName", "Mobile Number", "Wallet Balance", "KYC Status", "Actions", "Wallet History"];

    let $table = $('<table class="responsive-table highlight" id="userDetailsTable"></table>');

    let $headerRow = $('<thead class="tableheader"></thead>');
    let $headerRowContent = $("<tr></tr>");

    headers.forEach(function(headerText) {
      $headerRowContent.append($("<th></th>").text(headerText));
    });

    $headerRow.append($headerRowContent);
    $table.append($headerRow);

    let $tableBody = $("<tbody></tbody>");
    data.forEach(function(item) {
      let $row = $("<tr></tr>");

      let first_name = item["first_name"];
      let last_name = item["last_name"];
      let username = item["username"];
      let phone_number = item["phone_number"];
      let payout_wallet = item["payout_wallet"];
      let kyc_status = item["kyc_status"];
      let kycForUi = kyc_status === "True" ? "Active" : "Inactive";

      $row.append($("<td></td>").text(first_name));
      $row.append($("<td></td>").text(last_name));
      $row.append($("<td></td>").text(username));
      $row.append($("<td></td>").text(phone_number));
      $row.append($("<td></td>").text(payout_wallet));

      // Create dropdown as a string and set its selected value
      let statusDropDownHtml = `
        <select id="status-${username.replace(/[^a-zA-Z0-9]/g, "_")}" class="browser-default">
          <option value="" disabled>Select status</option>
          <option value="True" ${kyc_status === "True" ? "selected" : ""}>Active</option>
          <option value="False" ${kyc_status === "False" ? "selected" : ""}>Inactive</option>
        </select>
      `;

      $row.append($("<td class='left'></td>").html(statusDropDownHtml));
      $row.append($("<td></td>").html("<a class='waves-effect waves-light btn' onclick='updatingUserStatus(\"" + username + "\")'>Update User</a>"));
      $row.append($("<td></td>").html("<a class='waves-effect waves-light btn' id='historyBtn' onclick='showHistoryForUser(\"" + username + "\")'>History</a>"));
      $tableBody.append($row);
    });

    $table.append($tableBody);
    $("#userDetailsTableContainer").html($table);

    // Initialize DataTables
    $('#userDetailsTable').DataTable({
      paging: true,
      searching: true,
      ordering: true,
      pageLength: 5,
    });

    // Attach onChange event handler to dropdowns
    $("#userDetailsTable").on("change", "select[id^='status-']", function() {
      // Get the selected value
      let newStatus = $(this).val();
      // Get the username from the dropdown ID
      let username = $(this).attr("id").replace(/^status-/, "");
      // Call a function to handle the status change (replace with your function)
      updateUserStatus(username, newStatus);
    });
  } else {
    $("#userDetailsTableContainer").html("<p>No Users found.</p>");
  }
}

 function updatingUserStatus(userName) {
  var previousUserStatus = "";
  var preWalletBalance = "";
  for (let user of usersListPrev) {
    if (userName === user.username) {
      // Determine KYC status for UI
      const kycForUi = user.kyc_status === "True" ? "Active" : "InActive";
      previousUserStatus = kycForUi;
      // Update form fields
      $("#mobileNumber").val(user.phone_number);
      $("#userName").val(user.username);
      preWalletBalance = user.payout_wallet;
      $("#walletBalance").val(user.payout_wallet);
      $("#currentStatus").val(kycForUi);
      $("#rechargeAmount").val("");
      $("#newStatus").val("");
      $("#transType").val("");

      M.updateTextFields();
      // Exit loop once the user is found
      break;
    }
  }
  if (previousUserStatus === "Active") {
    M.toast({
         html: 'Please do Inactive the user before doing any transaction.'
        });
        return;
  }

  $('#manageUserDetailsModal').modal({
    onOpenEnd: function() {
      console.log('Modal opened. Previous status:', previousUserStatus);
    },
    onCloseEnd: function() {
      if (preWalletBalance != $("#walletBalance").val()) {
        location.reload();
      }
    }
  });

  $('#manageUserDetailsModal').modal('open');
}

    $("#transType").on("change", function(){
        var selectval = $(this).val();
        if (selectval == "Credit"){
          $(".rechargeBtn").html("Credit");
        } else if (selectval == "Debit") {
          $(".rechargeBtn").html("Debit");
        }
    });

    function updateUserStatus(userName, selectVal){
      // if(!selectVal){
      //   M.toast({
      //   html: 'Please select status type.'
      //  });
      //  return;
      // } else if (selectVal == "True") {
      //   M.toast({
      //   html: 'User is already Active.'
      //  });
      //  return;
      // } else if (selectVal == "False") {
      //   M.toast({
      //   html: 'User is already InActive.'
      //  });
      //  return;
      // } else {
          let url = "https://khazanapay.net/admin/updateKyc";
          const headers = {
            "Authorization": "Bearer "+access_token,
              "Content-Type": "application/json",
          };
          const payload = {
            username: userName,
            KYC_Status: selectVal,
          };
          $.ajax({
            url: url,
            type: "POST",
            headers: headers,
            data: JSON.stringify(payload),
            success: function (response) {
              location.reload();
            },
            error: function (xhr, status, error) {
              alert("Something went wrong. Please try again or please login again and try.");
              if (xhr.responseJSON && xhr.responseJSON.errorMsg) {
                var errorMessage = xhr.responseJSON.errorMsg;
                alert(errorMessage);
              } 
              return;
            },
          });
      // }

    }

    function creditOrDebitUserWallet() {
      var currentStatus = $("#currentStatus").val();
      var rechargeAmount = $("#rechargeAmount").val();
      var transType = $("#transType").val();
      $("#rechargeAmount").removeClass("invalid");
      $(".modalLoaderContent").addClass("active");

      if (currentStatus === "Active") {
        M.toast({
          html: 'Please inactive the user before doning any transactions.'
        });
        return;
      } else if (!rechargeAmount) {
          M.toast({
          html: 'Please enter valid amount.'
        });
        $("#rechargeAmount").addClass("invalid");
          return;
      } else if (rechargeAmount < 0) {
          M.toast({
            html: 'Please enter recharge amount greaterthan zero.'
          });
          $("#rechargeAmount").addClass("invalid");
          return;
      } else if (transType === "Credit"){
        $("#successStatus").addClass("hide");
        $("#errorStatus").addClass("hide");
        if (isProcessing) {
          M.toast({
            html: 'Please wait your previous transaction is processing.'
          });
          return;
        }
        isProcessing = true;
          let url = "https://khazanapay.net/admin/rechargeWallet";
          const headers = {
            "Authorization": "Bearer "+access_token,
             "Content-Type": "application/json",
          };
          const payload = {
            username: $("#userName").val(),
            amount : rechargeAmount
          };

          $('#modalLoader').modal('open');
          $.ajax({
            url: url,
            type: "POST",
            headers: headers,
            data: JSON.stringify(payload),
            success: function (response) {
              isProcessing = false;
              $(".modalLoaderContent").removeClass("active");
              $("#successStatus").removeClass("hide");
              return;
              setTimeout(function() {
                location.reload();
              }, 2000);
            },
            error: function (xhr, status, error) {
              $(".modalLoaderContent").removeClass("active");
              $("#errorStatus").removeClass("hide");
              isProcessing = false;
              alert("Something went wrong. Please login again.");
              window.location.href = "/";
              return;
            },
          });
      } else {

        if (!transType) {
          M.toast({
            html: 'Please select transaction type'
          });
        } else {
          M.toast({
            html: 'Debit action is under development.'
          });
        }
      }

    }


    function createWalletHistoryTable(data) {
      data.reverse();
      if (data) {
        let headers = ["Id", "User Name", "Client Id", "Amount", "Transaction Type", "Date", "Reason"];

        let $table = $('<table class="responsive-table highlight" id="walletHistoryTable"></table>');

        let $headerRow = $('<thead class="tabelheader"></thead>');
        let $headerRowContent = $("<tr></tr>");

        headers.forEach(function(headerText) {
          $headerRowContent.append($("<th></th>").text(headerText));
        });

        $headerRow.append($headerRowContent);
        $table.append($headerRow);

        let $tableBody = $("<tbody></tbody>");
        data.forEach(function(item) {
          let $row = $("<tr></tr>");

          let id = item["id"];
          let username = item["username"];
          let client_id = item["client_id"];
          let amount = item["amount"];
          let transaction_type = item["transaction_type"];
          let date_time = item["date_time"];
          const date = moment(date_time);
          const formattedDate = date.tz('Asia/Kolkata').format('DD-MM-YYYY HH:mm:ss');
          let reason = item["reason"];

          $row.append($("<td></td>").text(id));
          $row.append($("<td></td>").text(username));
          $row.append($("<td></td>").text(client_id));
          $row.append($("<td></td>").text(amount));
          $row.append($("<td></td>").text(transaction_type));
          $row.append($("<td></td>").text(formattedDate));
          $row.append($("<td></td>").text(reason));
          $tableBody.append($row);
        });

        $table.append($tableBody);
        $("#walletDetailsTableContainer").append($table);

        $table.DataTable({
          paging: true,
          searching: true,
          ordering: true,
          pageLength: 10,
          order:[], // No initial order; displays data as provided
        });
      } else {
        $("#walletDetailsTableContainer").append("<p>No transactions found.</p>");
      }
    }

  </script>
</body>
</html>
